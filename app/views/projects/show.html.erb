<% @meta_title = "#{@project} | Projects"%>
<% @meta_description = "Scientific papers mentioning #{@project.name}" %>

<div class="container-sm">
  <h2><%= link_to 'Projects', projects_path %>: <%= link_to @project.ecosystem, projects_ecosystem_path(@project.ecosystem) %>: <%= @project.name %></h2>

  <p>
    <%= link_to @project.ecosystems_url, @project.ecosystems_url, target: :_blank %>
  </p>

  <% if @project.package %>

      <p>
      <small class='text-muted'>
        <%= @project.description %>

        <% if @project.package['versions_count'] %>
          <br/><%= pluralize number_with_delimiter(@project.package['versions_count']), 'version' %>
        <% end %>

        <% if @project.package['latest_release_published_at'] %>
          <br/><span title="<%= @project.package['latest_release_published_at'] %>">Latest release: <%= time_ago_in_words @project.package['latest_release_published_at'] %> ago</span>
        <% end %>

        <% if @project.package['dependent_packages_count'] && @project.package['dependent_packages_count'] > 0 %>
          <br/><%= pluralize number_with_delimiter(@project.package['dependent_packages_count']), 'dependent package' %>
        <% end %>

        <% if @project.package['downloads'] %>
          <br/><%= number_with_delimiter(@project.package['downloads']) %> downloads <%= download_period(@project.package['downloads_period']) %>
        <% end %>
      </small>
    </p>

    <!-- Science Score Display -->
    <% if @project.science_score.present? %>
      <div class="mb-3">
        <%= science_score_badge(@project.science_score) %>
      </div>
    <% end %>

    <!-- Enhanced Data Display -->
    <% if @project.commits_data.present? || @project.readme_content.present? || @project.educational_commit_emails.present? %>
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="card-title mb-0">Enhanced Analysis</h5>
        </div>
        <div class="card-body">
          <% if @project.educational_commit_emails.present? %>
            <div class="mb-2">
              <strong>Educational Contributors:</strong>
              <% @project.educational_commit_emails.each do |email| %>
                <span class="badge bg-info me-1"><%= email %></span>
              <% end %>
            </div>
          <% end %>

          <% if @project.commits_data.present? %>
            <div class="mb-2">
              <strong>Repository Activity:</strong>
              <% if @project.commits_data['commits_count'] %>
                <%= number_with_delimiter(@project.commits_data['commits_count']) %> commits
              <% end %>
              <% if @project.commits_data['committers_count'] %>
                by <%= @project.commits_data['committers_count'] %> contributors
              <% end %>
            </div>
          <% end %>

          <% if @project.repository_owner_record.present? %>
            <div class="mb-2">
              <strong>Repository Owner:</strong>
              <% owner = @project.repository_owner_record %>
              <%= owner['name'] %> (<%= owner['kind'] %>)
              <% if owner['description'].present? %>
                <br/><small class="text-muted"><%= owner['description'] %></small>
              <% end %>
              <% if @project.academic_owner? %>
                <span class="badge bg-success ms-1">Academic</span>
              <% elsif @project.institutional_owner? %>
                <span class="badge bg-info ms-1">Institutional</span>
              <% end %>
            </div>
          <% end %>

          <% if @project.readme_content.present? %>
            <div class="mb-2">
              <strong>README Analysis:</strong>
              <% readme_text = @project.readme_content.downcase %>
              <% if readme_text.match?(/doi\.org\/10\.\d+/) %>
                <span class="badge bg-success me-1">DOI Found</span>
              <% end %>
              <% if readme_text.match?(/arxiv\.org\/abs\/\d+/) %>
                <span class="badge bg-success me-1">ArXiv Preprint</span>
              <% end %>
              <% if @project.package.dig('repo_metadata', 'metadata', 'files', 'citation').present? %>
                <span class="badge bg-success me-1">CITATION.cff</span>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

  <% end %>

  <h2>
    Papers Mentioning <%= @project.name %>
    <span class='badge bg-secondary'>
      <%= number_with_delimiter @project.mentions_count %>
    </span>
  </h2>

  <%= render @papers %>
  <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>  
</div>